# AprilTagBadgeReader

## 1. Flashing the ESP-EYE

This project detects apriltags using the ESP-EYE development board and uploads information about the detections to an AWS database.\
This is Track 4 of the [ESP32 Camera Integration Project](https://docs.google.com/document/d/1B1Nw_E98su2T_MYRsv42q9W8aAoufVafAxsERkIy82M/edit#heading=h.4nbkefahv1lc).

To flash ESP-EYE:
- Run run_cmake.sh
- `cd build`
- Enable PSRAM for image capturing and apriltag detection and disable 'WiFi IRAM Speed Optimization'.
    - `make menuconfig`
    - Component config > ESP32-specific > enable 'Support for external, SPI-connected RAM'
    - Component config > Wi-Fi > disable 'WiFi IRAM Speed Optimization'
- `make flash monitor`

If PSRAM is not enabled, the following error occurs:

I (353) camera: Allocating 300 KB frame buffer in PSRAM\
E (363) camera: Allocating 300 KB frame buffer Failed\
E (373) camera: Failed to allocate frame buffer\
E (373) gpio: gpio_isr_handler_remove(396): GPIO isr service is not installed, call gpio_install_isr_service() first\
E (383) camera: Camera init failed with error 0x101


If 'WiFi IRAM Speed Optimization' is enabled, the linker reports that the program will not fit.

## 2. Creating AWS Resources

### Resources

This project includes a CloudFormation template (src/CFtemplate.yml) which can be used with the AWS CloudFormation service to automatically generate all required resources and permissions. The resources generated by this template are:

- **DynamoDB Tables "DetectedTagsLog" and "PersonIDAssigned"**  
PersonIDAssigned holds the person's name assigned to each apriltag id.
DetectedTagsLog holds information about each detection including a timestamp, mac address of the device which detected the apriltag and inferred person identification.

- **Lambda Function (manage_database)**  
Python program which reads messages published to the MQTT topic, `badgeReader/topic/1` , gets a person's name assigned to the detected apriltag ID and adds detection information to a dynamoDB table.  

### Using Template
To use the CloudFormation template:  

- Go to the AWS CloudFormation service.
- Click "Create Stack"
- Upload a template file and select `src/CFtemplate.yml`
- Click next
- Enter a stack name
- Click next
- Check "I acknowledge that AWS CloudFormation might create IAM resources."
- Click create stack
- Wait for resources to be created.


### Assigning IDs
After creating the CloudFormation stack and verifying that resources were created successfully, IDs must be assigned to person's names to allow for identification.

To assign a person's name to an ID:

- Go to the AWS DynamoDB service
- Go to Tables
- Select the table, "PersonIDAssigned"
- Go to the Items tab
- Click "Create Item"
- Enter the apriltag ID to be assigned in the "Value" textbox.
- Click the "+" icon next to the Apriltag row and append a String value
- Enter `name` in the "Field" textbox and the person's name in the "Value" textbox
- Click Save

### Observing MQTT topic

Communication between the ESP-EYE and the cloud can be observed through the MQTT Client.

- Go to the AWS IoT Core service
- Click Test
- Click "Subscribe to a Topic"
- In the Subsription Topic textbox enter `badgeReader/topic/1`
- Click "Subscribe to topic"

Apriltags detected by the ESP-EYE should appear in the MQTT client and get logged in the "DetectedTagsLog" table.
